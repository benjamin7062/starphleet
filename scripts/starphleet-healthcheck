#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-ready <container_name> <container_port> <url>
### --help
###
### Check if a container is ready by looking for a successful http return.

HEALTHCHECK_TIMEOUT=${HEALTHCHECK_TIMEOUT:-30}

PORT=${container_port:-${PORT}}
URL=${url:-/}
IP_ADDRESS=$(lxc-ls --fancy | grep "^${container_name}[[:space:]]" | awk '{ print $3; }')

TEST_GET="http://${IP_ADDRESS}:${PORT}${URL}"
TEST_COMMAND="curl -X GET --connect-timeout ${HEALTHCHECK_TIMEOUT} -o /dev/null -s -w %{response_code} ${TEST_GET}"
RESULT=`${TEST_COMMAND}`
if [ ${RESULT} == "200" ]; then
  exit 0
fi

error Failed Healthcheck - ${TEST_GET}
exit 1
