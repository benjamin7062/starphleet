#!/usr/bin/env starphleet-launcher
### Usage:
###    starphleet-status [--metadata] [<service_name>]
### --help
###
### Dump out handy statistics about your ship.
### Options:
###    --trouble    filters down to just services that are not online

##ssl stats
SSL_EXPIRATION=$(openssl x509 -noout -in ${STARPHLEET_ROOT:-/var/starphleet}/nginx/crt -dates | head -1 | awk 'BEGIN { FS = "=" } ; { print $2 }')
STARPHLEET_DEV_DIR=/hosthome/starphleet_dev

if [ ${metadata} = true ]
then
#about the host
cat << EOF
hostname: $(hostname)
ssl_expiration: ${SSL_EXPIRATION}
EOF

#headquarters
cat << EOF
headquarters: ${HEADQUARTERS_REMOTE:-no headquarters}
EOF

##starphleet service processes
cat << EOF
services:
EOF
IFS=$'\n'
if [ -n "${service_name}" ]; then
  FILTER="${service_name}"
else
  FILTER="starphleet"
fi
for service in $(initctl list | grep ${FILTER} | sort)
do
cat << EOF
  - ${service}
EOF
done
unset IFS
fi


if [ -d "${CURRENT_ORDERS}" ]; then
cat << EOF
orders:
EOF
  if [ -n "${service_name}" ]; then
    FILTER="${service_name}"
  else
    FILTER=".container"
  fi
  for container_file in $(find "${CURRENT_ORDERS}" -regex '.*\.container$' | grep ${FILTER})
  do
    unset LATEST_SUCCESSFUL_CONTAINER_STATUS_FILE
    unset LATEST_SUCCESSFUL_CONTAINER
    unset ORDER
    unset AUTHOR
    unset CURRENT_SHA
    unset GIT_TEXT
    unset NGINX_POINTING_AT
    echo "    "
    echo "  --"
    echo "    "
    LATEST_SUCCESSFUL_CONTAINER_STATUS_FILE=$(dirname "${container_file}")/.starphleetstatus.$(cat "${container_file}")
    LATEST_SUCCESSFUL_STATUS=$(cat ${LATEST_SUCCESSFUL_CONTAINER_STATUS_FILE})
    LATEST_SUCCESSFUL_CONTAINER=$(echo ${LATEST_SUCCESSFUL_CONTAINER_STATUS_FILE} | sed -e 's/.*starphleetstatus\.//')
    ORDER="$(basename $(dirname ${LATEST_SUCCESSFUL_CONTAINER_STATUS_FILE}))"
    NGINX_POINTING_AT=$(curl --connect-timeout 1 -s -XHEAD -i "http://localhost/${ORDER}/" | grep "X-Starphleet-Container" | cut -f 2 -d " " | tr -dc '[[:print:]]')
    if dev_mode; then
      ORDER_LOCAL="${STARPHLEET_DEV_DIR}/${ORDER}"
    else
      ORDER_LOCAL="${HEADQUARTERS_LOCAL}/${ORDER}/git"
    fi
    if [ -d "${ORDER_LOCAL}" ]; then
      get_CURRENT_SHA "${ORDER_LOCAL}"
      cd "${ORDER_LOCAL}"
      AUTHOR=$(git log -1 --format='%ae')
      GIT_TEXT=$(git log -1 --format='%s')
    else
      CURRENT_SHA=""
      AUTHOR=""
      GIT_TEXT=""
    fi
    echo "    order          : ${ORDER}"
    echo "    latest active  : ${LATEST_SUCCESSFUL_CONTAINER}"
    echo "    nginx aimed at : ${NGINX_POINTING_AT}"
    echo "    latest status  : ${LATEST_SUCCESSFUL_STATUS}"
    echo "    git author     : ${AUTHOR}"
    echo "    git sha        : ${CURRENT_SHA}"
    echo "    latest git msg : ${GIT_TEXT}"
    echo "    "
    echo "    Containers"
    echo "    ------------"
    for container_status_file in $(find "${CURRENT_ORDERS}/${ORDER}" -type f -name ".starphleetstatus.*" | grep --extended-regexp -e ".*${ORDER}-([a-f0-9]){7}-([a-f0-9]){7}$")
    do
      unset CONTAINER
      unset STATUS
      unset LOCAL_IP
      unset LOCAL_PORT
      CONTAINER=$(echo ${container_status_file} | sed -e 's/.*starphleetstatus\.//')
      STATUS=$(cat "${container_status_file}")
      LOCAL_IP=$([ -f "${container_status_file}.ip" ] && cat "${container_status_file}.ip")
      LOCAL_PORT=$([ -f "${container_status_file}.port" ] && cat "${container_status_file}.port")
      echo "    ${CONTAINER} - [${LOCAL_IP}:${LOCAL_PORT}] - [${STATUS}]"
    done # End container_status_file
  done # End container_file
fi
